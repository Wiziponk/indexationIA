<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indexation v3</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" defer></script>
  <style>
    /* On-screen debug drawer */
    #debugWrap { position: fixed; right: 12px; bottom: 12px; width: 380px; max-height: 40vh; z-index: 9999; }
    #debugHead { background:#1e293b; color:#e2e8f0; padding:6px 10px; border-radius:10px 10px 0 0; font-size:12px; cursor:pointer; }
    #debugBody { background:#0f172a; color:#cbd5e1; border:1px solid #334155; border-top:0; padding:10px; border-radius:0 0 10px 10px; display:none; overflow:auto; max-height:34vh; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }
    #debugBody pre { margin:0; white-space:pre-wrap; word-break:break-word; }
    .badge.loading { background:#233145; }
    .ok { color:#10b981; }
    .err { color:#f87171; }
  </style>
</head>
<body>
  <div class="container">
    <div class="flex">
      <h1>Indexation v3</h1>
      <span class="badge right" id="health">checkingâ€¦</span>
    </div>

    <!-- DATASET & CLIPS -->
    <div class="card">
      <h2>1) Dataset & Clips</h2>
      <div class="grid">
        <div class="col-12">
          <button id="btnLoadFields">Load fields from API</button>
          <span class="small" id="apiInfo"></span>
          <span class="small" id="fieldsCount"></span>
        </div>
        <div class="col-4">
          <label>Primary key</label>
          <select id="primaryKey"></select>
        </div>
        <div class="col-8">
          <label>Fields to include for program embeddings</label>
          <select id="embedFields" multiple size="6"></select>
        </div>

        <div class="col-12">
          <label>Scope</label>
          <div class="flex">
            <label><input type="radio" name="mode" value="api" checked> Full API</label>
            <label><input type="radio" name="mode" value="excel"> Filter by Excel/CSV IDs</label>
          </div>
        </div>

        <div class="col-6" id="excelCol" style="display:none">
          <label>Upload Excel/CSV of IDs</label>
          <input type="file" id="idsFile" accept=".csv,.xlsx,.xls" />
          <div class="small" id="idsCols"></div>
          <div class="grid" style="margin-top:8px;">
            <div class="col-8">
              <label>ID Column</label>
              <select id="idsColSelect"></select>
            </div>
            <div class="col-4" style="padding-top:28px;">
              <button id="btnIdsPreview" class="secondary">Preview IDs</button>
            </div>
          </div>
          <div class="small" id="idsToken" style="display:none"></div>
          <div style="max-height:180px; overflow:auto;"><table class="table" id="idsTable"></table></div>
        </div>

        <div class="col-6">
          <label>Transcripts (.docx) â€” filenames must contain numeric ID</label>
          <input type="file" id="transcripts" multiple accept=".docx" />
        </div>

        <div class="col-12">
          <button id="btnPrepare">Prepare dataset (exclude items without transcript)</button>
          <span class="small" id="prepInfo"></span>
        </div>

        <div class="col-6">
          <label>Pick one emission to preview</label>
          <select id="samplePk"></select>
        </div>
        <div class="col-6">
          <label>Clip settings</label>
          <div class="flex">
            <label>Keep ratio <input type="number" id="keepRatio" step="0.05" value="0.6" style="width:90px; margin-left:6px;"></label>
            <label style="margin-left:12px;">Brief <input type="text" id="brief" placeholder="(optional)" style="margin-left:6px; width:240px;"></label>
            <label style="margin-left:12px;"><input type="checkbox" id="withTitles"> Name clips (chat)</label>
          </div>
        </div>

        <div class="col-12">
          <button id="btnPreviewClips" class="secondary">Preview clip maker (one emission)</button>
        </div>

        <div class="col-12">
          <div style="max-height:320px; overflow:auto; margin-top:8px;">
            <table class="table" id="clipsPreview"></table>
          </div>
        </div>

        <div class="col-12">
          <button id="btnBatch">Produce ZIPs for all included emissions</button>
          <span class="small" id="batchLinks"></span>
        </div>
      </div>
    </div>

    <!-- CLUSTER FROM ZIPS -->
    <div class="card">
      <h2>2) Cluster from ZIPs</h2>
      <div class="grid">
        <div class="col-12"><h3>2a) Cluster by Clips</h3></div>
        <div class="col-8">
          <label>Upload program ZIPs</label>
          <input type="file" id="clipZips" multiple accept=".zip" />
        </div>
        <div class="col-4">
          <label>Options</label>
          <div class="flex">
            <label>Algo
              <select id="algoClips">
                <option value="kmeans">K-Means</option>
                <option value="dbscan">DBSCAN</option>
              </select>
            </label>
            <label>K
              <select id="kClips">
                <option value="auto">Auto</option><option>4</option><option>6</option><option>8</option><option>10</option>
              </select>
            </label>
            <label>Proj
              <select id="projClips">
                <option value="pca">PCA</option><option value="tsne">t-SNE</option>
              </select>
            </label>
          </div>
        </div>
        <div class="col-12">
          <button id="btnClusterClips">Run clustering (clips)</button>
        </div>

        <div class="col-12"><h3>2b) Cluster by Emission</h3></div>
        <div class="col-8">
          <label>Upload program ZIPs</label>
          <input type="file" id="emZips" multiple accept=".zip" />
        </div>
        <div class="col-4">
          <label>Options</label>
          <div class="flex">
            <label>Algo
              <select id="algoEm">
                <option value="kmeans">K-Means</option>
                <option value="dbscan">DBSCAN</option>
              </select>
            </label>
            <label>K
              <select id="kEm">
                <option value="auto">Auto</option><option>4</option><option>6</option><option>8</option><option>10</option>
              </select>
            </label>
            <label>Proj
              <select id="projEm">
                <option value="pca">PCA</option><option value="tsne">t-SNE</option>
              </select>
            </label>
          </div>
        </div>
        <div class="col-12">
          <button id="btnClusterEm">Run clustering (emissions)</button>
        </div>
      </div>

      <div id="chart" style="height:720px; margin-top:12px;"></div>
      <div>
        <table class="table" id="summary">
          <thead><tr><th>Cluster</th><th>Items</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Debug drawer -->
  <div id="debugWrap">
    <div id="debugHead">ðŸ›  Debug (click)</div>
    <div id="debugBody">
      <div id="dbgErrors"></div>
      <pre id="dbgLog"></pre>
    </div>
  </div>

<script>
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));

// On-screen error capture
(function wireDebug(){
  const head = $('#debugHead'), body = $('#debugBody');
  head.addEventListener('click', ()=>{ body.style.display = body.style.display ? '' : 'none'; });
  window.addEventListener('error', (e) => {
    $('#dbgErrors').innerHTML = `<div class="err"><b>JS Error:</b> ${e.message}</div>`;
    body.style.display = '';
  });
  window.addEventListener('unhandledrejection', (e) => {
    $('#dbgErrors').innerHTML = `<div class="err"><b>Promise Rejection:</b> ${e.reason}</div>`;
    body.style.display = '';
  });
})();
function dlog(label, obj) {
  const pre = $('#dbgLog');
  const line = `[${new Date().toLocaleTimeString()}] ${label}: ` + (obj ? JSON.stringify(obj, null, 2) : '');
  pre.textContent = (line + "\n\n" + pre.textContent).slice(0, 40000);
}

function startLoading(btn, label = "Workingâ€¦") {
  if (!btn) return () => {};
  btn.dataset.oldText = btn.textContent;
  btn.disabled = true;
  btn.textContent = label;
  $('#health')?.classList.add('loading');
  return () => stopLoading(btn);
}
function stopLoading(btn) {
  if (!btn) return;
  btn.disabled = false;
  if (btn.dataset.oldText) btn.textContent = btn.dataset.oldText;
  $('#health')?.classList.remove('loading');
}
async function fetchJSON(url, options={}, btn=null) {
  const r = await fetch(url, options);
  const text = await r.text();
  let body = null;
  try { body = text ? JSON.parse(text) : null; } catch { body = { detail: text }; }
  dlog(`HTTP ${r.status} ${url}`, body);
  if (!r.ok) {
    const msg = (body && (body.detail || body.error)) ? (Array.isArray(body.detail) ? body.detail.map(x=>x.msg||x).join(", ") : body.detail) : `HTTP ${r.status}`;
    if (btn) stopLoading(btn);
    alert(`Error: ${msg}`);
    throw new Error(msg);
  }
  return body || {};
}

async function health() {
  try {
    const js = await fetchJSON('/api/health');
    $('#health').textContent = js.ok ? `OK â€¢ ${js.version}` : 'Not OK';
  } catch { $('#health').textContent = 'Not OK'; }
}
health();

// toggles
$$('input[name="mode"]').forEach(r => r.addEventListener('change', () => {
  const isExcel = document.querySelector('input[name="mode"]:checked').value === 'excel';
  $('#excelCol').style.display = isExcel ? '' : 'none';
}));

let idsToken = null;
let idsIdCol = null;

function renderSelect(el, items) {
  el.innerHTML = '';
  for (const v of items) {
    const o = document.createElement('option');
    o.value = v; o.textContent = v;
    el.appendChild(o);
  }
}

// Load fields (HARDENED)
$('#btnLoadFields').addEventListener('click', async (ev) => {
  const done = startLoading(ev.currentTarget, "Loading API fieldsâ€¦");
  const js = await fetchJSON('/api/fields', {}, ev.currentTarget);
  const fields = Array.isArray(js.fields) ? js.fields : [];
  $('#apiInfo').textContent = 'API: ' + (js.api_base || '');
  $('#fieldsCount').innerHTML = fields.length ? `<span class="ok">${fields.length} fields loaded</span>` : '<span class="err">0 field found</span>';

  const pk = $('#primaryKey');
  const ef = $('#embedFields');
  renderSelect(pk, fields);
  renderSelect(ef, fields);

  // Preselect sane defaults if present
  const pkGuesses = ['code_emission','codeEmission','id','video_id','uid'];
  const efGuesses = ['title','titre','synopsis','description','summary'];
  for (const g of pkGuesses) {
    const opt = Array.from(pk.options).find(o => o.value === g);
    if (opt) { pk.value = g; break; }
  }
  for (const g of efGuesses) {
    const opt = Array.from(ef.options).find(o => o.value === g);
    if (opt) opt.selected = true;
  }

  // Make sure selects are visible even if empty
  pk.size = Math.min(8, pk.options.length || 1);
  ef.size = Math.min(8, Math.max(6, ef.options.length || 6));

  done();
});

// Upload IDs preview
$('#btnIdsPreview').addEventListener('click', async (ev) => {
  const done = startLoading(ev.currentTarget, "Uploadingâ€¦");
  const f = $('#idsFile').files[0]; if (!f) { alert('Choose a file'); done(); return; }
  const fd = new FormData(); fd.append('excel', f);
  const js = await fetchJSON('/api/upload-ids', { method:'POST', body:fd }, ev.currentTarget);
  idsToken = js.token;
  $('#idsToken').style.display = '';
  $('#idsToken').textContent = 'Token: ' + idsToken;

  const cols = js.columns || [];
  $('#idsCols').innerHTML = 'Columns: ' + cols.map(c => `<code>${c}</code>`).join(' ');

  const sel = $('#idsColSelect'); renderSelect(sel, cols);
  sel.value = cols[0] || '';
  idsIdCol = sel.value; sel.addEventListener('change', ()=>{ idsIdCol = sel.value; });

  const tbl = $('#idsTable'); tbl.innerHTML = '';
  if (js.preview && js.preview.length) {
    const thead = document.createElement('thead'); const trh = document.createElement('tr');
    Object.keys(js.preview[0]).forEach(c => { const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); }); thead.appendChild(trh); tbl.appendChild(thead);
    const tb=document.createElement('tbody');
    js.preview.forEach(row => { const tr=document.createElement('tr'); Object.values(row).forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); }); tb.appendChild(tr); }); tbl.appendChild(tb);
  }
  done();
});

// Prepare dataset
$('#btnPrepare').addEventListener('click', async (ev) => {
  const done = startLoading(ev.currentTarget, "Preparingâ€¦");
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const pk = $('#primaryKey').value;
  const fields = Array.from($('#embedFields').selectedOptions).map(o => o.value);
  if (!pk || !fields.length) { alert('Pick a primary key and at least one field'); done(); return; }
  const fd = new FormData();
  fd.append('mode', mode);
  fd.append('primary_key', pk);
  fields.forEach(f => fd.append('embed_fields', f));
  if (mode === 'excel') {
    if (!idsToken) { alert('Preview the Excel first'); done(); return; }
    fd.append('excel_token', idsToken);
    fd.append('excel_id_col', idsIdCol || '');
  }
  Array.from($('#transcripts').files).forEach(f => fd.append('transcripts', f));
  const js = await fetchJSON('/api/segment/prepare', { method:'POST', body:fd }, ev.currentTarget);
  $('#prepInfo').textContent = `Included: ${js.count_included} â€¢ Excluded (no transcript): ${js.count_excluded}`;
  const sel = $('#samplePk'); renderSelect(sel, js.sample_ids || []);
  done();
});

// Preview clip maker (one)
$('#btnPreviewClips').addEventListener('click', async (ev) => {
  const done = startLoading(ev.currentTarget, "Previewingâ€¦");
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const pk = $('#primaryKey').value;
  const fields = Array.from($('#embedFields').selectedOptions).map(o => o.value);
  const samplePk = $('#samplePk').value;
  if (!samplePk) { alert('Pick an emission ID in "Pick one emission"'); done(); return; }
  const fd = new FormData();
  fd.append('mode', mode);
  fd.append('primary_key', pk);
  fields.forEach(f => fd.append('embed_fields', f));
  if (mode === 'excel') { fd.append('excel_token', idsToken); fd.append('excel_id_col', idsIdCol || ''); }
  fd.append('sample_pk_value', samplePk);
  fd.append('keep_ratio', $('#keepRatio').value);
  const brief = $('#brief').value.trim(); if (brief) fd.append('brief', brief);
  fd.append('with_titles', $('#withTitles').checked ? 'true':'false');
  Array.from($('#transcripts').files).forEach(f => fd.append('transcripts', f));
  const js = await fetchJSON('/api/segment/preview', { method:'POST', body:fd }, ev.currentTarget);
  const tbl = $('#clipsPreview'); tbl.innerHTML = '';
  if (js.segments && js.segments.length) {
    const thead=document.createElement('thead'); const trh=document.createElement('tr');
    ['start','end','score','title','summary','text'].forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); }); thead.appendChild(trh); tbl.appendChild(thead);
    const tb=document.createElement('tbody');
    js.segments.forEach(s => {
      const tr=document.createElement('tr');
      ['start','end','score','title','summary','text'].forEach(c=>{ const td=document.createElement('td'); td.textContent=s[c] ?? ''; tr.appendChild(td); });
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
  }
  done();
});

// Batch ZIPs
$('#btnBatch').addEventListener('click', async (ev) => {
  const done = startLoading(ev.currentTarget, "Producing ZIPsâ€¦");
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const pk = $('#primaryKey').value;
  const fields = Array.from($('#embedFields').selectedOptions).map(o => o.value);
  const fd = new FormData();
  fd.append('mode', mode);
  fd.append('primary_key', pk);
  fields.forEach(f => fd.append('embed_fields', f));
  if (mode === 'excel') { if (!idsToken) { alert('Preview the Excel first'); done(); return; } fd.append('excel_token', idsToken); fd.append('excel_id_col', idsIdCol || ''); }
  fd.append('keep_ratio', $('#keepRatio').value);
  const brief = $('#brief').value.trim(); if (brief) fd.append('brief', brief);
  fd.append('with_titles', 'true');
  Array.from($('#transcripts').files).forEach(f => fd.append('transcripts', f));
  const js = await fetchJSON('/api/segment/batch', { method:'POST', body:fd }, ev.currentTarget);
  $('#batchLinks').innerHTML = `Master: <a href="${js.master_zip}">${js.master_zip.split('/').pop()}</a> (${js.count} zips)`;
  done();
});

// Cluster â€” clips
$('#btnClusterClips').addEventListener('click', async (ev) => {
  const done = startLoading(ev.currentTarget, "Clustering clipsâ€¦");
  const files = $('#clipZips').files; if (!files.length) { alert('Upload some program ZIPs'); done(); return; }
  const fd = new FormData();
  for (const f of files) fd.append('packages', f);
  fd.append('algo_choice', $('#algoClips').value);
  fd.append('k_choice', $('#kClips').value);
  fd.append('proj_choice', $('#projClips').value);
  const js = await fetchJSON('/api/cluster/clips', { method:'POST', body:fd }, ev.currentTarget);
  drawChart(js);
  done();
});

// Cluster â€” emissions
$('#btnClusterEm').addEventListener('click', async (ev) => {
  const done = startLoading(ev.currentTarget, "Clustering emissionsâ€¦");
  const files = $('#emZips').files; if (!files.length) { alert('Upload some program ZIPs'); done(); return; }
  const fd = new FormData();
  for (const f of files) fd.append('packages', f);
  fd.append('algo_choice', $('#algoEm').value);
  fd.append('k_choice', $('#kEm').value);
  fd.append('proj_choice', $('#projEm').value);
  const js = await fetchJSON('/api/cluster/emissions', { method:'POST', body:fd }, ev.currentTarget);
  drawChart(js);
  done();
});

function drawChart(js) {
  if (!js.points) { alert('No points'); return; }
  const clusters = [...new Set(js.points.map(p => p.cluster))].sort((a,b)=>a-b);
  const traces = clusters.map(c => {
    const pts = js.points.filter(p => p.cluster === c);
    return { x: pts.map(p => p.x), y: pts.map(p => p.y), mode: 'markers', type: 'scattergl',
             name: `Cluster ${c}`, text: pts.map(p => p.pk),
             hovertemplate: "<b>%{text}</b><br>x=%{x:.2f}, y=%{y:.2f}<extra></extra>",
             marker: { size: 9 } };
  });
  Plotly.newPlot('chart', traces, { title: `k=${js.meta.k ?? ''} ${js.meta.silhouette >= 0 ? '(silhouette '+js.meta.silhouette.toFixed(3)+')' : ''}`, height: 720, margin:{l:40,r:10,t:60,b:40} }, {displayModeBar:true});
  // summary
  const by = new Map(); js.points.forEach(p => { if (!by.has(p.cluster)) by.set(p.cluster, 0); by.set(p.cluster, by.get(p.cluster)+1); });
  const rows = [...by.entries()].map(([c,n])=>({c,n})).sort((a,b)=>a.c-b.c);
  const tbody = $('#summary tbody'); tbody.innerHTML='';
  rows.forEach(r => { const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.c}</td><td>${r.n}</td>`; tbody.appendChild(tr); });
}
</script>
</body>
</html>
