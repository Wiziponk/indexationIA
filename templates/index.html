<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Edu Topics — Configuration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  <style>
    .step { border-radius: 16px; padding: 16px; background: #121418; color: #e9eef3; margin-bottom: 16px; }
    .chip { display:inline-block; padding:6px 10px; border-radius:18px; background:#0f1115; border:1px solid #2a2f36; margin:4px; }
    .muted { color:#9aa6b2; }
    .loading { opacity: 0.6; pointer-events: none; }
    .table-preview { max-height: 280px; overflow: auto; }
  </style>
</head>
<body class="bg-dark text-light">
<div class="container py-4">

  <h1 class="mb-3">Edu Topics — Configurer l’analyse</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-danger">
        {% for msg in messages %}
          <div>{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h2 class="mt-4">Génération d’embeddings</h2>

  <!-- STEP 1: API connection & fields -->
  <div class="step">
    <h5 class="mb-2">Étape 1 — Source API</h5>
    <div class="mb-2">
      <div class="muted">API: <code id="apiBase">{{ api_base }}</code></div>
      <button id="btnLoadFields" class="btn btn-outline-light btn-sm mt-2">Charger les champs depuis l’API</button>
      <span id="loadSpinner" class="ms-2 d-none spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    </div>
    <div id="fieldsRow" class="row g-2 mt-1 d-none">
      <div class="col-md-4">
        <label class="form-label">Clé primaire (ID)</label>
        <select id="primaryKey" class="form-select form-select-sm"></select>
        <div class="form-text text-secondary">Suggestions: {{ id_guess|join(", ") }}</div>
      </div>
      <div class="col-md-8">
        <label class="form-label">Champs à inclure dans l’embedding</label>
        <select id="embedFields" class="form-select form-select-sm" multiple size="6"></select>
        <div class="form-text text-secondary">Astuce : sélectionne titre, synopsis/description, thèmes…</div>
      </div>
    </div>
  </div>

  <!-- STEP 2: Choose mode (all from API vs Excel filter) -->
  <div class="step">
    <h5 class="mb-2">Étape 2 — Périmètre d’analyse</h5>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="mode" id="modeApi" value="api" checked>
      <label class="form-check-label" for="modeApi">
        Utiliser <strong>tout</strong> le catalogue retourné par l’API
      </label>
    </div>
    <div class="form-check mt-2">
      <input class="form-check-input" type="radio" name="mode" id="modeExcel" value="excel">
      <label class="form-check-label" for="modeExcel">
        Importer un Excel/CSV contenant une liste de <em>codes émission</em> à analyser
      </label>
    </div>

    <div id="excelZone" class="mt-3 d-none">
      <form id="excelPreviewForm" class="border rounded p-3">
        <label class="form-label">Fichier Excel/CSV</label>
        <input type="file" name="excel" id="excelFile" class="form-control form-control-sm" accept=".csv,.xlsx,.xls" />
        <button id="btnPreview" class="btn btn-secondary btn-sm mt-2" type="submit">Prévisualiser</button>
        <span id="excelSpinner" class="ms-2 d-none spinner-border spinner-border-sm"></span>

        <div id="excelConfig" class="mt-3 d-none">
          <label class="form-label">Colonne contenant le code émission / identifiant</label>
          <select id="excelIdCol" class="form-select form-select-sm"></select>
          <div class="form-text text-secondary">On fera correspondre cette colonne avec la <strong>clé primaire</strong> choisie plus haut.</div>
        </div>

        <div id="excelPreview" class="table-preview mt-3 d-none">
          <table class="table table-dark table-striped table-sm">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </form>
    </div>
  </div>

  <!-- STEP 3: Embedding preview -->
  <div id="embedPreview" class="step d-none">
    <h5 class="mb-2">Étape 3 — Aperçu de l’embedding</h5>
    <div id="embedPreviewContent" class="small"></div>
  </div>

  <h2 class="mt-4">Clustering</h2>

    <!-- STEP 4: Clustering options -->
    <div class="step">
      <h5 class="mb-2">Étape 4 — Options de clustering</h5>
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Nombre de clusters</label>
          <select id="kChoice" class="form-select form-select-sm">
            <option value="auto" selected>Auto (recommandé)</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8">8</option>
            <option value="10">10</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Algorithme</label>
          <select id="algoChoice" class="form-select form-select-sm">
            <option value="kmeans" selected>K-Means</option>
            <option value="dbscan">DBSCAN</option>
          </select>
        </div>
      </div>
    </div>

    <!-- STEP 5: Optional files + submit -->
    <div class="step">
      <h5 class="mb-2">Étape 5 — Fichiers optionnels & lancement</h5>
      <form id="runForm" method="post" action="{{ url_for('ingest') }}" enctype="multipart/form-data">
        <input type="hidden" name="mode" id="f_mode" value="api">
        <input type="hidden" name="primary_key" id="f_primary_key">
        <input type="hidden" name="k_choice" id="f_k_choice" value="auto">
        <input type="hidden" name="algo_choice" id="f_algo_choice" value="kmeans">
        <div id="embedHidden"></div>
        <input type="hidden" name="excel_token" id="f_excel_token">
        <input type="hidden" name="excel_id_col" id="f_excel_id_col">

        <div class="mb-3">
          <label class="form-label">Transcriptions (.docx)</label>
          <input type="file" name="transcripts" id="transcripts" class="form-control form-control-sm" multiple accept=".docx" />
          <div class="form-text text-secondary">Les noms doivent contenir l’identifiant numérique (ex: AUTHOR_123456.docx).</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Embeddings pré-générés (.npy)</label>
          <input type="file" name="embedding_file" id="embeddingFile" class="form-control form-control-sm" accept=".npy" />
        </div>

        <button id="btnRun" class="btn btn-primary">Analyser</button>
        <span id="runSpinner" class="ms-2 d-none spinner-border spinner-border-sm"></span>
      </form>
      <div class="muted mt-2">Le traitement peut prendre un peu de temps selon la taille.</div>
    </div>

</div>

<script>
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));

let excelToken = null;

function setLoading(btnId, spinnerId, on) {
  const btn = $(btnId); const sp = $(spinnerId);
  if (!btn || !sp) return;
  if (on) { btn.classList.add('loading'); sp.classList.remove('d-none'); }
  else { btn.classList.remove('loading'); sp.classList.add('d-none'); }
}

async function updateEmbedPreview() {
  const pk = $("#primaryKey").value;
  const fields = Array.from($("#embedFields").selectedOptions).map(o => o.value);
  if (!pk || !fields.length) {
    $("#embedPreview").classList.add("d-none");
    return;
  }
  try {
    const params = new URLSearchParams({ primary_key: pk, fields: fields.join(",") });
    const res = await fetch(`{{ url_for('api_sample') }}?${params.toString()}`);
    const js = await res.json();
    if (!js.sample) { return; }
    let html = `<div><strong>${pk}</strong>: ${js.sample[pk] ?? ''}</div>`;
    fields.forEach(f => { html += `<div><strong>${f}</strong>: ${js.sample[f] ?? ''}</div>`; });
    const tnames = Array.from($("#transcripts").files).map(f => f.name);
    if (tnames.length) {
      html += `<div class=\"mt-2\"><strong>Transcriptions</strong>: ${tnames.join(", ")}</div>`;
    }
    $("#embedPreviewContent").innerHTML = html;
    $("#embedPreview").classList.remove("d-none");
  } catch (e) {
    console.error(e);
  }
}

function populateFields(fields) {
  const pk = $("#primaryKey");
  const ef = $("#embedFields");
  pk.innerHTML = "";
  ef.innerHTML = "";
  fields.forEach(f => {
    const opt1 = document.createElement("option");
    opt1.value = f; opt1.textContent = f;
    pk.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = f; opt2.textContent = f;
    ef.appendChild(opt2);
  });
}

function showFieldsRow(show) {
  $("#fieldsRow").classList.toggle("d-none", !show);
}

document.getElementById("btnLoadFields").addEventListener("click", async () => {
  setLoading("#btnLoadFields", "#loadSpinner", true);
  try {
    const res = await fetch("{{ url_for('api_fields') }}");
    const js = await res.json();
    if (js.fields && js.fields.length) {
      populateFields(js.fields);
      showFieldsRow(true);
      // Preselect best guesses
      const guesses = {{ id_guess|tojson }};
      const pk = $("#primaryKey");
      for (const g of guesses) {
        const opt = Array.from(pk.options).find(o => o.value === g);
        if (opt) { pk.value = g; break; }
      }
      // Preselect common text fields
      const common = ["title","titre","synopsis","description","summary"];
      const ef = $("#embedFields");
      Array.from(ef.options).forEach(o => { if (common.includes(o.value)) o.selected = true; });
    } else {
      alert("Impossible de récupérer les champs depuis l’API.");
    }
  } catch (e) {
    console.error(e);
    alert("Erreur lors de l’appel à l’API des champs.");
  } finally {
    setLoading("#btnLoadFields", "#loadSpinner", false);
  }
});

$("#primaryKey").addEventListener("change", updateEmbedPreview);
$("#embedFields").addEventListener("change", updateEmbedPreview);
$("#transcripts").addEventListener("change", updateEmbedPreview);

// Toggle Excel zone
$$('input[name="mode"]').forEach(r => {
  r.addEventListener("change", () => {
    const isExcel = $("#modeExcel").checked;
    $("#excelZone").classList.toggle("d-none", !isExcel);
  });
});

// Excel preview
$("#excelPreviewForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = $("#excelFile").files[0];
  if (!file) { alert("Choisir un fichier."); return; }
  const fd = new FormData();
  fd.append("excel", file);
  setLoading("#btnPreview", "#excelSpinner", true);
  try {
    const res = await fetch("{{ url_for('preview_excel') }}", { method: "POST", body: fd });
    const js = await res.json();
    if (js.error) { alert(js.error); return; }
    excelToken = js.token;
    // Fill ID column choices
    const sel = $("#excelIdCol");
    sel.innerHTML = "";
    js.columns.forEach(c => {
      const o = document.createElement("option");
      o.value = c; o.textContent = c; sel.appendChild(o);
    });
    $("#excelConfig").classList.remove("d-none");
    // Render preview table
    const head = $("#excelPreview thead"); head.innerHTML = "";
    const body = $("#excelPreview tbody"); body.innerHTML = "";
    const cols = js.columns;
    const trh = document.createElement("tr");
    cols.forEach(c => { const th = document.createElement("th"); th.textContent = c; trh.appendChild(th); });
    head.appendChild(trh);
    js.preview.forEach(row => {
      const tr = document.createElement("tr");
      cols.forEach(c => { const td = document.createElement("td"); td.textContent = row[c]; tr.appendChild(td); });
      body.appendChild(tr);
    });
    $("#excelPreview").classList.remove("d-none");
  } catch (e2) {
    console.error(e2);
    alert("Erreur de prévisualisation.");
  } finally {
    setLoading("#btnPreview", "#excelSpinner", false);
  }
});

// Submit run
  $("#runForm").addEventListener("submit", (e) => {
    // move UI selections into hidden fields
    const mode = $("#modeExcel").checked ? "excel" : "api";
    $("#f_mode").value = mode;
    $("#f_primary_key").value = $("#primaryKey").value;
    $("#f_k_choice").value = $("#kChoice").value;
    $("#f_algo_choice").value = $("#algoChoice").value;

  // embed fields
  const wrap = $("#embedHidden");
  wrap.innerHTML = "";
  Array.from($("#embedFields").selectedOptions).forEach(o => {
    const inp = document.createElement("input");
    inp.type = "hidden";
    inp.name = "embed_fields";
    inp.value = o.value;
    wrap.appendChild(inp);
  });

    if (mode === "excel") {
      if (!excelToken) { e.preventDefault(); alert("Prévisualiser d’abord le fichier Excel."); return; }
      $("#f_excel_token").value = excelToken;
      $("#f_excel_id_col").value = $("#excelIdCol").value;
    }

  $("#btnRun").classList.add("disabled");
  $("#runSpinner").classList.remove("d-none");
});
</script>

</body>
</html>
